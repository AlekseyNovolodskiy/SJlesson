<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Теннисное табло</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        .counter-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .counter {
            border: 2px solid #333;
            padding: 20px;
            width: 150px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .winner-message {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 20px;
        }
        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
<h1>Теннисное табло</h1>
<div class="counter-container">
    <div class="counter">
        <h2>игрок <span id="player1Name">[[${playerOneName}]]</span></h2>
        <p class="score">Очки: <span id="counter1">0</span></p>
        <p class="score">Сет: <span id="set1">0</span></p>
        <p class="score">Гейм: <span id="game1">0</span></p>
        <button id="player1Btn" onclick="incrementCounter(1)">+1</button>
    </div>
    <div class="counter">
        <h2>игрок <span id="player2Name">[[${playerTwoName}]]</span></h2>
        <p class="score">Очки: <span id="counter2">0</span></p>
        <p class="score">Сет: <span id="set2">0</span></p>
        <p class="score">Гейм: <span id="game2">0</span></p>
        <button id="player2Btn" onclick="incrementCounter(2)">+1</button>
    </div>
</div>
<div id="winnerMessage" class="winner-message"></div>

<script>
    let counter1 = 0;
    let counter2 = 0;
    let set1 = 0;
    let set2 = 0;
    let game1 = 0;
    let game2 = 0;
    const maxSets = 3;
    let gameFinished = false;

    // Получаем имена игроков из Thymeleaf
    const playerOneName = "[[${playerOneName}]]";
    const playerTwoName = "[[${playerTwoName}]]";

    // Устанавливаем имена в DOM
    document.getElementById('player1Name').textContent = playerOneName;
    document.getElementById('player2Name').textContent = playerTwoName;

    function incrementCounter(counterNumber) {
        if (gameFinished) return;

        if (counterNumber === 1) {
            if (counter1 === 0) counter1 = 15;
            else if (counter1 === 15) counter1 = 30;
            else if (counter1 === 30) counter1 = 40;
            else if (counter1 === 40) {
                game1++;
                counter1 = 0;
                counter2 = 0;

                if (game1 >= 6 && game1 - game2 >= 2) {
                    set1++;
                    game1 = 0;
                    game2 = 0;

                    if (set1 === maxSets) {
                        endGame(1);
                        return;
                    }
                }
            }
            updateScores();
        } else if (counterNumber === 2) {
            if (counter2 === 0) counter2 = 15;
            else if (counter2 === 15) counter2 = 30;
            else if (counter2 === 30) counter2 = 40;
            else if (counter2 === 40) {
                game2++;
                counter1 = 0;
                counter2 = 0;

                if (game2 >= 6 && game2 - game1 >= 2) {
                    set2++;
                    game1 = 0;
                    game2 = 0;

                    if (set2 === maxSets) {
                        endGame(2);
                        return;
                    }
                }
            }
            updateScores();
        }
    }

    function updateScores() {
        document.getElementById('counter1').textContent = counter1;
        document.getElementById('game1').textContent = game1;
        document.getElementById('set1').textContent = set1;
        document.getElementById('counter2').textContent = counter2;
        document.getElementById('game2').textContent = game2;
        document.getElementById('set2').textContent = set2;
    }

    function endGame(winnerNumber) {
        gameFinished = true;
        const winnerName = winnerNumber === 1 ? playerOneName : playerTwoName;
        document.getElementById('winnerMessage').textContent = `Победитель: ${winnerName}!`;

        document.getElementById('player1Btn').classList.add('disabled');
        document.getElementById('player2Btn').classList.add('disabled');

        sendWinnerToServer(winnerName);
    }

    function sendWinnerToServer(winnerName) {
        // Кодируем имя для URL
        const encodedWinner = encodeURIComponent(winnerName);

        fetch(`/save-winner?winner=${encodedWinner}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сети');
                }
                return response.text();
            })
            .then(data => {
                console.log('Ответ сервера:', data);
            })
            .catch(error => {
                console.error('Ошибка при отправке победителя:', error);
            });
    }
</script>
</body>
</html>